<?php
declare(strict_types=1);

namespace Mnemesong\Structure\collections;

use Mnemesong\Structure\StructureInterface;
use Webmozart\Assert\Assert;

/**
 * Collection of StructureInterfaces.
 *
 * Generated by: mnemesong\collection-generator v.0.4
 */
class StructureInterfaceCollection implements \Countable, \JsonSerializable
{
    /* @var \Mnemesong\Structure\StructureInterface[] $objects */
    /* @phpstan-ignore-next-line  */
    protected array $objects = [];

    /**
     * @param StructureInterface[] $objects
     */
    public function __construct(array $objects = [])
    {
        foreach ($objects as $object) {
            $this->add($object);
        }
    }

    /**
     * @param \Mnemesong\Structure\StructureInterface $object
     * @return void
     */
    public function add(StructureInterface $object): void
    {
        $this->objects[] = $object;
    }

    /**
     * @param \Mnemesong\Structure\StructureInterface $object
     * @return int|null
     */
    protected function getIndex(StructureInterface $object): ?int
    {
        $filtered = array_filter($this->objects, function (StructureInterface $innerObject) use ($object) {
            return $innerObject == $object;
        });
        if(count($filtered) > 0) {
            return current(array_keys($filtered));
        }
        return null;
    }

    /**
     * @param \Mnemesong\Structure\StructureInterface $object
     * @return int[]
     */
    protected function getAllIndexes(StructureInterface $object): array
    {
        $filtered = array_filter($this->objects, function (StructureInterface $innerObject) use ($object) {
            return $innerObject == $object;
        });
        return array_keys($filtered);
    }

    /**
     * @return StructureInterface[]
     */
    public function getAll(): array
    {
        return $this->objects;
    }

    /**
     * @param \Mnemesong\Structure\StructureInterface $object
     * @return self
     * @throws \ErrorException
     */
    public function removeObject(StructureInterface $object): self
    {
        $index = $this->getIndex($object);
        if(!isset($index)) {
            throw new \ErrorException('Not found element in collection ' . static::class);
        }
        unset($this->objects[$index]);
        $this->objects = array_values($this->objects);
        return $this;
    }

    /**
     * @param \Mnemesong\Structure\StructureInterface $object
     * @return self
     * @throws \ErrorException
     */
    public function removeAll(StructureInterface $object): self
    {
        while($this->getIndex($object) !== null)
        {
            $this->removeObject($object);
        }
        return $this;
    }

    /**
     * @param callable $callbackFunction
     * @return self
     */
    public function filter(callable $callbackFunction): self
    {
        $this->objects = array_values(array_filter($this->objects, $callbackFunction));
        return $this;
    }

    /**
     * @param callable $callbackFunction
     * @return int[]
     */
    public function searchIndexesOf(callable $callbackFunction): array
    {
        $newArray = array_filter($this->objects, $callbackFunction);
        return array_keys($newArray);
    }

    /**
     * @param callable $callbackFunction
     * @return array
     */
    /* @phpstan-ignore-next-line  */
    public function map(callable $callbackFunction): array
    {
        return array_map($callbackFunction, $this->objects);
    }

    /**
     * @param callable $callbackFunction
     * @return self
     * @throws \ErrorException
     */
    public function apply(callable $callbackFunction): self
    {
        $newArray = array_map($callbackFunction, $this->objects);
        $checkFilter = array_filter($newArray, function ($item) {
            return !is_a($item, StructureInterface::class);
        });
        if(!empty($checkFilter)) {
            throw new \ErrorException('Wrong type result at Apply() method execution in collection ' . static::class);
        }
        $this->objects = $newArray;
        return $this;
    }

    /**
     * @return int
     */
    public function count(): int
    {
        return count($this->objects);
    }

    /**
     * @param int $index
     * @return \Mnemesong\Structure\StructureInterface|null
     */
    public function getByIndex(int $index): ?StructureInterface
    {
        if(!isset($this->objects[$index])) {
            return null;
        }
        return $this->objects[$index];
    }

    /**
     * @param int $index
     * @return int|null
     */
    public function getNextIndex(int $index): ?int
    {
        $index++;
        if(isset($this->objects[$index])) {
            return $index;
        }
        return null;
    }

    /**
     * @return int
     */
    public function getFirstIndex(): ?int
    {
        $index = array_key_first($this->objects);
        if(is_null($index)) {
            return null;
        }
        Assert::integer($index);
        return $index;
    }

    /**
     * @return \Mnemesong\Structure\StructureInterface[]
     */
    public function jsonSerialize(): array
    {
        return $this->objects;
    }

    /**
     * @return \Mnemesong\Structure\StructureInterface
     */
    public function getFirst(): StructureInterface
    {
        if($this->count() === 0) {
            throw new \RuntimeException('Error: try to get first element from empty StructureInterfaces collection');
        }
        return $this->objects[array_key_first($this->objects)];
    }

    /**
     * @return \Mnemesong\Structure\StructureInterface
     */
    public function getLast(): StructureInterface
    {
        if($this->count() === 0) {
            throw new \RuntimeException('Error: try to get last element from empty StructureInterfaces collection');
        }
        return $this->objects[array_key_last($this->objects)];
    }

    /**
     * @param callable $func
     * @return self
     */
    public function assertCount(callable $func): self
    {
        if($func($this->count()) !== true) {
            throw new \AssertionError('Count assert error');
        }
        return $this;
    }

    /**
     * @return \Mnemesong\Structure\StructureInterface|null
     */
    public function getFirstOrNull(): ?StructureInterface
    {
        if($this->count() > 0) {
            return $this->getFirst();
        }
        return null;
    }

    /**
     * @return \Mnemesong\Structure\StructureInterface|null
     */
    public function getLastOrNull(): ?StructureInterface
    {
        if($this->count() > 0) {
            return $this->getLast();
        }
        return null;
    }

    /**
     * @param callable $sortFunc
     * @return $this
     * @throws \ErrorException
     */
    public function sort(callable $sortFunc): self
    {
        if(uasort($this->objects, $sortFunc) === false) {
            throw new \ErrorException('Error while resorting collection');
        }
        $this->objects = array_values($this->objects);
        return $this;
    }

    /**
     * @param int $index
     * @param \Mnemesong\Structure\StructureInterface $newItem
     * @return $this
     */
    public function replaceItemByIndex(int $index, StructureInterface $newItem): self
    {
        if(empty($this->objects[$index])) {
            throw new \RuntimeException('Element for replacing had not found');
        }
        $this->objects[$index] = $newItem;
        return $this;
    }
}